name: CI/CD Test

on:
  push:
    branches:
      - main

jobs:
  setup:
    name: Setup Terraform
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Install terraform
        id: install
        env:
          TF_VERSION: "1.3.6"
        run: |
          wget "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
          unzip terraform_${TF_VERSION}_linux_amd64.zip
          sudo mv terraform /usr/local/bin

  terraform_init:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Terraform Init
        run: terraform init

  terraform_plan:
    runs-on: ubuntu-latest
    needs:
      - terraform_init
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Terraform Plan
        run: terraform plan

  terraform_apply:
    runs-on: ubuntu-latest
    needs:
      - terraform_plan
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Terraform Apply
        run: terraform apply
        # Aquí agregamos la estrategia de aprobación manual
        # para que el trabajo quede en espera de aprobación
        strategy:
          matrix:
            include:
              - name: Aprobar
                approval: true
        run: |
          echo "Test terraform apply"
        # Configuramos la estrategia para esperar a que se apruebe manualmente
        # antes de continuar con los otros trabajos en el flujo de trabajo
        fail-fast: false